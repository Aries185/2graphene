commit 102e7d51865385cbf22bad3fabb48849fb5ae07e
Author: Daniel Micay <danielmicay@gmail.com>
Date:   Wed 2018-12-12 01:10:55-0500

    include AVB custom key with factory images [1/2]
---
 clear-factory-images-variables.sh |  1 +
 generate-factory-images-common.sh | 22 ++++++++++++++++++++++
 2 files changed, 23 insertions(+)

diff --git a/clear-factory-images-variables.sh b/clear-factory-images-variables.sh
index dc508e120fbe4df2c58985dd318f7a5123831916..799f6c4cca21821925bd09a088422b8eb771d0ce 100644
--- a/clear-factory-images-variables.sh
+++ b/clear-factory-images-variables.sh
@@ -5,20 +5,21 @@
 # You may obtain a copy of the License at
 #
 #      http://www.apache.org/licenses/LICENSE-2.0
 #
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
+unset AVB_PKMD
 unset BOOTLOADER
 unset BOOTLOADERFILE
 unset BOOTLOADERSRC
 unset BUILD
 unset CDMARADIO
 unset CDMARADIOFILE
 unset DEVICE
 unset ERASE
 unset PRODUCT
 unset RADIO
diff --git a/generate-factory-images-common.sh b/generate-factory-images-common.sh
index 95f4e35c846810c99d6d46388061d6ef94618116..5628a25578fcbdff23542f68979de40043e87feb 100644
--- a/generate-factory-images-common.sh
+++ b/generate-factory-images-common.sh
@@ -75,20 +75,24 @@ then
 fi
 if test "$CDMARADIO" != ""
 then
   if test "$CDMARADIOFILE" = ""
   then
     cp tmp/RADIO/radio-cdma.img tmp/$PRODUCT-$VERSION/radio-cdma-$DEVICE-$CDMARADIO.img
   else
     cp $CDMARADIOFILE tmp/$PRODUCT-$VERSION/radio-cdma-$DEVICE-$CDMARADIO.img
   fi
 fi
+if test "$AVB_PKMD" != ""
+then
+  cp "$AVB_PKMD" tmp/$PRODUCT-$VERSION/avb_pkmd.bin
+fi
 
 # Write flash-all.sh
 cat > tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
 #!/bin/sh
 
 # Copyright 2012 The Android Open Source Project
 #
 # Licensed under the Apache License, Version 2.0 (the "License");
 # you may not use this file except in compliance with the License.
 # You may obtain a copy of the License at
@@ -150,20 +154,29 @@ sleep $SLEEPDURATION
 EOF
 fi
 if test "$CDMARADIO" != ""
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
 fastboot flash radio-cdma radio-cdma-$DEVICE-$CDMARADIO.img
 fastboot reboot-bootloader
 sleep $SLEEPDURATION
 EOF
 fi
+if test "$AVB_PKMD" != ""
+then
+cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
+fastboot erase avb_custom_key
+fastboot flash avb_custom_key avb_pkmd.bin
+fastboot reboot-bootloader
+sleep $SLEEPDURATION
+EOF
+fi
 cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
 fastboot -w update image-$PRODUCT-$VERSION.zip
 EOF
 chmod a+x tmp/$PRODUCT-$VERSION/flash-all.sh
 
 # Write flash-all.bat
 cat > tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 @ECHO OFF
 :: Copyright 2012 The Android Open Source Project
 ::
@@ -225,20 +238,29 @@ ping -n $SLEEPDURATION 127.0.0.1 >nul
 EOF
 fi
 if test "$CDMARADIO" != ""
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 fastboot flash radio-cdma radio-cdma-$DEVICE-$CDMARADIO.img
 fastboot reboot-bootloader
 ping -n $SLEEPDURATION 127.0.0.1 >nul
 EOF
 fi
+if test "$AVB_PKMD" != ""
+then
+cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
+fastboot erase avb_custom_key
+fastboot flash avb_custom_key avb_pkmd.bin
+fastboot reboot-bootloader
+ping -n $SLEEPDURATION 127.0.0.1 >nul
+EOF
+fi
 cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 fastboot -w update image-$PRODUCT-$VERSION.zip
 
 echo Press any key to exit...
 pause >nul
 exit
 EOF
 
 # Write flash-base.sh
 cat > tmp/$PRODUCT-$VERSION/flash-base.sh << EOF

commit 74d7497b4e2b3460336f590f058fbd2e5b9a8d10
Author: Daniel Micay <danielmicay@gmail.com>
Date:   Sat 2019-03-16 12:54:05-0400

    use https for common gps configuration
---
 gps/gps.conf_AS      | 6 +++---
 gps/gps.conf_AS_SUPL | 6 +++---
 gps/gps.conf_EU      | 6 +++---
 gps/gps.conf_EU_SUPL | 6 +++---
 gps/gps.conf_US      | 6 +++---
 gps/gps.conf_US_SUPL | 6 +++---
 6 files changed, 18 insertions(+), 18 deletions(-)

diff --git a/gps/gps.conf_AS b/gps/gps.conf_AS
index ce3a4e2cb8c4d8ec3cbc0f2f72e079e64d12a345..4a788f98c2b2f212e62367edc73825edde966770 100644
--- a/gps/gps.conf_AS
+++ b/gps/gps.conf_AS
@@ -1,3 +1,3 @@
-XTRA_SERVER_1=http://xtra1.gpsonextra.net/xtra.bin
-XTRA_SERVER_2=http://xtra2.gpsonextra.net/xtra.bin
-XTRA_SERVER_3=http://xtra3.gpsonextra.net/xtra.bin
+XTRA_SERVER_1=https://xtra1.gpsonextra.net/xtra.bin
+XTRA_SERVER_2=https://xtra2.gpsonextra.net/xtra.bin
+XTRA_SERVER_3=https://xtra3.gpsonextra.net/xtra.bin
diff --git a/gps/gps.conf_AS_SUPL b/gps/gps.conf_AS_SUPL
index a0e2a7d14896c21c63b182900a83b2949ab5b44b..27c95e74132b42ba633f0e420db38c185ab9eea2 100644
--- a/gps/gps.conf_AS_SUPL
+++ b/gps/gps.conf_AS_SUPL
@@ -1,5 +1,5 @@
-XTRA_SERVER_1=http://xtra1.gpsonextra.net/xtra.bin
-XTRA_SERVER_2=http://xtra2.gpsonextra.net/xtra.bin
-XTRA_SERVER_3=http://xtra3.gpsonextra.net/xtra.bin
+XTRA_SERVER_1=https://xtra1.gpsonextra.net/xtra.bin
+XTRA_SERVER_2=https://xtra2.gpsonextra.net/xtra.bin
+XTRA_SERVER_3=https://xtra3.gpsonextra.net/xtra.bin
 SUPL_HOST=supl.google.com
 SUPL_PORT=7276
diff --git a/gps/gps.conf_EU b/gps/gps.conf_EU
index ce3a4e2cb8c4d8ec3cbc0f2f72e079e64d12a345..4a788f98c2b2f212e62367edc73825edde966770 100644
--- a/gps/gps.conf_EU
+++ b/gps/gps.conf_EU
@@ -1,3 +1,3 @@
-XTRA_SERVER_1=http://xtra1.gpsonextra.net/xtra.bin
-XTRA_SERVER_2=http://xtra2.gpsonextra.net/xtra.bin
-XTRA_SERVER_3=http://xtra3.gpsonextra.net/xtra.bin
+XTRA_SERVER_1=https://xtra1.gpsonextra.net/xtra.bin
+XTRA_SERVER_2=https://xtra2.gpsonextra.net/xtra.bin
+XTRA_SERVER_3=https://xtra3.gpsonextra.net/xtra.bin
diff --git a/gps/gps.conf_EU_SUPL b/gps/gps.conf_EU_SUPL
index a0e2a7d14896c21c63b182900a83b2949ab5b44b..27c95e74132b42ba633f0e420db38c185ab9eea2 100644
--- a/gps/gps.conf_EU_SUPL
+++ b/gps/gps.conf_EU_SUPL
@@ -1,5 +1,5 @@
-XTRA_SERVER_1=http://xtra1.gpsonextra.net/xtra.bin
-XTRA_SERVER_2=http://xtra2.gpsonextra.net/xtra.bin
-XTRA_SERVER_3=http://xtra3.gpsonextra.net/xtra.bin
+XTRA_SERVER_1=https://xtra1.gpsonextra.net/xtra.bin
+XTRA_SERVER_2=https://xtra2.gpsonextra.net/xtra.bin
+XTRA_SERVER_3=https://xtra3.gpsonextra.net/xtra.bin
 SUPL_HOST=supl.google.com
 SUPL_PORT=7276
diff --git a/gps/gps.conf_US b/gps/gps.conf_US
index ce3a4e2cb8c4d8ec3cbc0f2f72e079e64d12a345..4a788f98c2b2f212e62367edc73825edde966770 100644
--- a/gps/gps.conf_US
+++ b/gps/gps.conf_US
@@ -1,3 +1,3 @@
-XTRA_SERVER_1=http://xtra1.gpsonextra.net/xtra.bin
-XTRA_SERVER_2=http://xtra2.gpsonextra.net/xtra.bin
-XTRA_SERVER_3=http://xtra3.gpsonextra.net/xtra.bin
+XTRA_SERVER_1=https://xtra1.gpsonextra.net/xtra.bin
+XTRA_SERVER_2=https://xtra2.gpsonextra.net/xtra.bin
+XTRA_SERVER_3=https://xtra3.gpsonextra.net/xtra.bin
diff --git a/gps/gps.conf_US_SUPL b/gps/gps.conf_US_SUPL
index a0e2a7d14896c21c63b182900a83b2949ab5b44b..27c95e74132b42ba633f0e420db38c185ab9eea2 100644
--- a/gps/gps.conf_US_SUPL
+++ b/gps/gps.conf_US_SUPL
@@ -1,5 +1,5 @@
-XTRA_SERVER_1=http://xtra1.gpsonextra.net/xtra.bin
-XTRA_SERVER_2=http://xtra2.gpsonextra.net/xtra.bin
-XTRA_SERVER_3=http://xtra3.gpsonextra.net/xtra.bin
+XTRA_SERVER_1=https://xtra1.gpsonextra.net/xtra.bin
+XTRA_SERVER_2=https://xtra2.gpsonextra.net/xtra.bin
+XTRA_SERVER_3=https://xtra3.gpsonextra.net/xtra.bin
 SUPL_HOST=supl.google.com
 SUPL_PORT=7276

commit bd335a42d56bfaecbcf6b2ce4cfcc4befd5f98f4
Author: SatelliteSnyper <51929686+SatelliteSnyper@users.noreply.github.com>
Date:   Mon 2019-06-17 20:12:05+0000

    use --skip-reboot to stay in fastboot mode
    
    This allows locking the bootloader without needing to reboot back into
    fastboot mode.
---
 generate-factory-images-common.sh | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/generate-factory-images-common.sh b/generate-factory-images-common.sh
index 5628a25578fcbdff23542f68979de40043e87feb..a138551047a88c13807a0a61f48e38c9c8fc3074 100644
--- a/generate-factory-images-common.sh
+++ b/generate-factory-images-common.sh
@@ -164,21 +164,21 @@ fi
 if test "$AVB_PKMD" != ""
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
 fastboot erase avb_custom_key
 fastboot flash avb_custom_key avb_pkmd.bin
 fastboot reboot-bootloader
 sleep $SLEEPDURATION
 EOF
 fi
 cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
-fastboot -w update image-$PRODUCT-$VERSION.zip
+fastboot -w --skip-reboot update image-$PRODUCT-$VERSION.zip
 EOF
 chmod a+x tmp/$PRODUCT-$VERSION/flash-all.sh
 
 # Write flash-all.bat
 cat > tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 @ECHO OFF
 :: Copyright 2012 The Android Open Source Project
 ::
 :: Licensed under the Apache License, Version 2.0 (the "License");
 :: you may not use this file except in compliance with the License.
@@ -248,21 +248,21 @@ fi
 if test "$AVB_PKMD" != ""
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 fastboot erase avb_custom_key
 fastboot flash avb_custom_key avb_pkmd.bin
 fastboot reboot-bootloader
 ping -n $SLEEPDURATION 127.0.0.1 >nul
 EOF
 fi
 cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
-fastboot -w update image-$PRODUCT-$VERSION.zip
+fastboot -w --skip-reboot update image-$PRODUCT-$VERSION.zip
 
 echo Press any key to exit...
 pause >nul
 exit
 EOF
 
 # Write flash-base.sh
 cat > tmp/$PRODUCT-$VERSION/flash-base.sh << EOF
 #!/bin/sh
 

commit 2e5d136687fbb140bfa7c3c07db9f328971ed198
Author: Daniel Micay <danielmicay@gmail.com>
Date:   Fri 2020-05-01 15:52:26-0400

    use more sensible factory images zip naming scheme
---
 generate-factory-images-common.sh | 3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

diff --git a/generate-factory-images-common.sh b/generate-factory-images-common.sh
index a138551047a88c13807a0a61f48e38c9c8fc3074..9a318e598fe13c46b6f9ff2ecd01f48563a7b75e 100644
--- a/generate-factory-images-common.sh
+++ b/generate-factory-images-common.sh
@@ -316,15 +316,14 @@ if test "$CDMARADIO" != ""
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-base.sh << EOF
 fastboot flash radio-cdma radio-cdma-$DEVICE-$CDMARADIO.img
 fastboot reboot-bootloader
 sleep $SLEEPDURATION
 EOF
 fi
 chmod a+x tmp/$PRODUCT-$VERSION/flash-base.sh
 
 # Create the distributable package
-(cd tmp ; zip -r ../$PRODUCT-$VERSION-factory.zip $PRODUCT-$VERSION)
-mv $PRODUCT-$VERSION-factory.zip $PRODUCT-$VERSION-factory-$(sha256sum < $PRODUCT-$VERSION-factory.zip | cut -b -8).zip
+(cd tmp; mv $PRODUCT-$VERSION $PRODUCT-factory-$VERSION; zip -r ../$PRODUCT-factory-$VERSION.zip $PRODUCT-factory-$VERSION)
 
 # Clean up
 rm -rf tmp

commit 7a9e57c30380ab834558766837528cb390251b17
Author: JTL <jtl999@users.noreply.github.com>
Date:   Mon 2020-06-01 10:45:25-0700

    Fastboot version detection on Windows using inline PowerShell
---
 generate-factory-images-common.sh | 21 +++++++++++++++++++++
 1 file changed, 21 insertions(+)

diff --git a/generate-factory-images-common.sh b/generate-factory-images-common.sh
index 9a318e598fe13c46b6f9ff2ecd01f48563a7b75e..df1b2759a30123f2b78010252a0daea57cbe77f7 100644
--- a/generate-factory-images-common.sh
+++ b/generate-factory-images-common.sh
@@ -186,20 +186,41 @@ cat > tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 ::
 ::      http://www.apache.org/licenses/LICENSE-2.0
 ::
 :: Unless required by applicable law or agreed to in writing, software
 :: distributed under the License is distributed on an "AS IS" BASIS,
 :: WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 :: See the License for the specific language governing permissions and
 :: limitations under the License.
 
 PATH=%PATH%;"%SYSTEMROOT%\System32"
+
+:: Detect Fastboot version with inline PowerShell
+:: Should work with Windows 7 and later
+
+@PowerShell ^
+\$version=fastboot --version; ^
+try { ^
+    \$verNum = \$version[0].substring(17, 6); ^
+    \$verNum = \$verNum.replace('.', ''); ^
+    if ((-Not (\$verNum -ge 3103)) -Or (-Not (\$verNum -match '^[\d.]+$'))) { ^
+        Exit 1 ^
+    } ^
+} catch { ^
+    Exit 1 ^
+}
+
+IF %ERRORLEVEL% NEQ 0 (
+  ECHO fastboot too old; please download the latest version at https://developer.android.com/studio/releases/platform-tools.html
+  EXIT /B
+)
+
 EOF
 if test "$UNLOCKBOOTLOADER" = "true"
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 fastboot oem unlock
 EOF
 fi
 if test "$ERASEALL" = "true"
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF

commit b485df4b184e50280eeef2fb5b7e1612ff14b6f8
Author: Chirayu Desai <chirayudesai1@gmail.com>
Date:   Wed 2020-06-03 03:59:34+0530

    Reboot to bootloader after installing update
    
    * Can't lock bootloader from fastbootd,
      reboot to bootloader to allow that.
    * Doesn't hurt on other devices, keeps the script simple.
---
 generate-factory-images-common.sh | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/generate-factory-images-common.sh b/generate-factory-images-common.sh
index df1b2759a30123f2b78010252a0daea57cbe77f7..f1f2ebc96f27912a15b7e5c61d02dc7dff7754a9 100644
--- a/generate-factory-images-common.sh
+++ b/generate-factory-images-common.sh
@@ -165,20 +165,22 @@ if test "$AVB_PKMD" != ""
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
 fastboot erase avb_custom_key
 fastboot flash avb_custom_key avb_pkmd.bin
 fastboot reboot-bootloader
 sleep $SLEEPDURATION
 EOF
 fi
 cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
 fastboot -w --skip-reboot update image-$PRODUCT-$VERSION.zip
+fastboot reboot-bootloader
+sleep $SLEEPDURATION
 EOF
 chmod a+x tmp/$PRODUCT-$VERSION/flash-all.sh
 
 # Write flash-all.bat
 cat > tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 @ECHO OFF
 :: Copyright 2012 The Android Open Source Project
 ::
 :: Licensed under the Apache License, Version 2.0 (the "License");
 :: you may not use this file except in compliance with the License.
@@ -270,20 +272,22 @@ if test "$AVB_PKMD" != ""
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 fastboot erase avb_custom_key
 fastboot flash avb_custom_key avb_pkmd.bin
 fastboot reboot-bootloader
 ping -n $SLEEPDURATION 127.0.0.1 >nul
 EOF
 fi
 cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 fastboot -w --skip-reboot update image-$PRODUCT-$VERSION.zip
+fastboot reboot-bootloader
+ping -n $SLEEPDURATION 127.0.0.1 >nul
 
 echo Press any key to exit...
 pause >nul
 exit
 EOF
 
 # Write flash-base.sh
 cat > tmp/$PRODUCT-$VERSION/flash-base.sh << EOF
 #!/bin/sh
 

commit b8aba0737e7f10b996c29f4a8a5c20e057a376c0
Author: Maxim Baz <git@maximbaz.com>
Date:   Tue 2020-10-27 16:25:20+0100

    gracefully handle absence of fastboot
---
 generate-factory-images-common.sh | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/generate-factory-images-common.sh b/generate-factory-images-common.sh
index f1f2ebc96f27912a15b7e5c61d02dc7dff7754a9..0efff882b077839cf7c80e4067e395d4501176bd 100644
--- a/generate-factory-images-common.sh
+++ b/generate-factory-images-common.sh
@@ -98,20 +98,25 @@ cat > tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
 # You may obtain a copy of the License at
 #
 #      http://www.apache.org/licenses/LICENSE-2.0
 #
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
+if ! command -v fastboot > /dev/null; then
+  echo "fastboot not found; please download the latest version at https://developer.android.com/studio/releases/platform-tools.html and add it to the shell PATH"
+  exit 1
+fi
+
 if ! [ \$(\$(which fastboot) --version | grep "version" | cut -c18-23 | sed 's/\.//g' ) -ge 3103 ]; then
   echo "fastboot too old; please download the latest version at https://developer.android.com/studio/releases/platform-tools.html"
   exit 1
 fi
 EOF
 if test "$UNLOCKBOOTLOADER" = "true"
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
 fastboot oem unlock
 EOF
@@ -192,20 +197,22 @@ cat > tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 :: distributed under the License is distributed on an "AS IS" BASIS,
 :: WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 :: See the License for the specific language governing permissions and
 :: limitations under the License.
 
 PATH=%PATH%;"%SYSTEMROOT%\System32"
 
 :: Detect Fastboot version with inline PowerShell
 :: Should work with Windows 7 and later
 
+where /q fastboot || ECHO fastboot not found; please download the latest version at https://developer.android.com/studio/releases/platform-tools.html and add it to the shell PATH && EXIT /B
+
 @PowerShell ^
 \$version=fastboot --version; ^
 try { ^
     \$verNum = \$version[0].substring(17, 6); ^
     \$verNum = \$verNum.replace('.', ''); ^
     if ((-Not (\$verNum -ge 3103)) -Or (-Not (\$verNum -match '^[\d.]+$'))) { ^
         Exit 1 ^
     } ^
 } catch { ^
     Exit 1 ^
@@ -298,20 +305,25 @@ cat > tmp/$PRODUCT-$VERSION/flash-base.sh << EOF
 # You may obtain a copy of the License at
 #
 #      http://www.apache.org/licenses/LICENSE-2.0
 #
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
+if ! command -v fastboot > /dev/null; then
+  echo "fastboot not found; please download the latest version at https://developer.android.com/studio/releases/platform-tools.html and add it to the shell PATH"
+  exit 1
+fi
+
 if ! [ \$(\$(which fastboot) --version | grep "version" | cut -c18-23 | sed 's/\.//g' ) -ge 3103 ]; then
   echo "fastboot too old; please download the latest version at https://developer.android.com/studio/releases/platform-tools.html"
   exit 1
 fi
 EOF
 if test "$XLOADER" != ""
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-base.sh << EOF
 fastboot flash xloader xloader-$DEVICE-$XLOADER.img
 EOF

commit 5958dc94cf2e29456cba41bf6c7bf5d15fb8ebc1
Author: flawedworld <38294951+flawedworld@users.noreply.github.com>
Date:   Tue 2021-07-13 18:24:44+0000

    Add support for disabling UART
---
 clear-factory-images-variables.sh |  1 +
 generate-factory-images-common.sh | 12 ++++++++++++
 2 files changed, 13 insertions(+)

diff --git a/clear-factory-images-variables.sh b/clear-factory-images-variables.sh
index 799f6c4cca21821925bd09a088422b8eb771d0ce..cb5895c930041e70f236933826df59c63993b056 100644
--- a/clear-factory-images-variables.sh
+++ b/clear-factory-images-variables.sh
@@ -13,20 +13,21 @@
 # limitations under the License.
 
 unset AVB_PKMD
 unset BOOTLOADER
 unset BOOTLOADERFILE
 unset BOOTLOADERSRC
 unset BUILD
 unset CDMARADIO
 unset CDMARADIOFILE
 unset DEVICE
+unset DISABLE_UART
 unset ERASE
 unset PRODUCT
 unset RADIO
 unset RADIOFILE
 unset RADIOSRC
 unset RADIOFILE
 unset SLEEPDURATION
 unset SRCPREFIX
 unset UNLOCKBOOTLOADER
 unset VERSION
diff --git a/generate-factory-images-common.sh b/generate-factory-images-common.sh
index 0efff882b077839cf7c80e4067e395d4501176bd..ee1b1aded7f6e526007cdd57f49c0ad8e5d22ba9 100644
--- a/generate-factory-images-common.sh
+++ b/generate-factory-images-common.sh
@@ -168,20 +168,26 @@ EOF
 fi
 if test "$AVB_PKMD" != ""
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
 fastboot erase avb_custom_key
 fastboot flash avb_custom_key avb_pkmd.bin
 fastboot reboot-bootloader
 sleep $SLEEPDURATION
 EOF
 fi
+if test "$DISABLE_UART" = "true"
+then
+cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
+fastboot oem uart disable
+EOF
+fi
 cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
 fastboot -w --skip-reboot update image-$PRODUCT-$VERSION.zip
 fastboot reboot-bootloader
 sleep $SLEEPDURATION
 EOF
 chmod a+x tmp/$PRODUCT-$VERSION/flash-all.sh
 
 # Write flash-all.bat
 cat > tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 @ECHO OFF
@@ -277,20 +283,26 @@ EOF
 fi
 if test "$AVB_PKMD" != ""
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 fastboot erase avb_custom_key
 fastboot flash avb_custom_key avb_pkmd.bin
 fastboot reboot-bootloader
 ping -n $SLEEPDURATION 127.0.0.1 >nul
 EOF
 fi
+if test "$DISABLE_UART" = "true"
+then
+cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
+fastboot oem uart disable
+EOF
+fi
 cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 fastboot -w --skip-reboot update image-$PRODUCT-$VERSION.zip
 fastboot reboot-bootloader
 ping -n $SLEEPDURATION 127.0.0.1 >nul
 
 echo Press any key to exit...
 pause >nul
 exit
 EOF
 

commit 471287aa3c6209571498cb57a1a8df60417beca6
Author: flawedworld <flawedworld@flawed.world>
Date:   Thu 2021-12-16 23:06:29+0000

    Add support for erasing apdp
---
 clear-factory-images-variables.sh |  1 +
 generate-factory-images-common.sh | 14 ++++++++++++++
 2 files changed, 15 insertions(+)

diff --git a/clear-factory-images-variables.sh b/clear-factory-images-variables.sh
index cb5895c930041e70f236933826df59c63993b056..c7be106128f5041ca4a053142734eb1b3d259e85 100644
--- a/clear-factory-images-variables.sh
+++ b/clear-factory-images-variables.sh
@@ -15,20 +15,21 @@
 unset AVB_PKMD
 unset BOOTLOADER
 unset BOOTLOADERFILE
 unset BOOTLOADERSRC
 unset BUILD
 unset CDMARADIO
 unset CDMARADIOFILE
 unset DEVICE
 unset DISABLE_UART
 unset ERASE
+unset ERASE_APDP
 unset PRODUCT
 unset RADIO
 unset RADIOFILE
 unset RADIOSRC
 unset RADIOFILE
 unset SLEEPDURATION
 unset SRCPREFIX
 unset UNLOCKBOOTLOADER
 unset VERSION
 unset TWINBOOTLOADERS
diff --git a/generate-factory-images-common.sh b/generate-factory-images-common.sh
index ee1b1aded7f6e526007cdd57f49c0ad8e5d22ba9..8bfe8a97c7564da31b0d92734d573c55620b8df9 100644
--- a/generate-factory-images-common.sh
+++ b/generate-factory-images-common.sh
@@ -174,20 +174,27 @@ fastboot flash avb_custom_key avb_pkmd.bin
 fastboot reboot-bootloader
 sleep $SLEEPDURATION
 EOF
 fi
 if test "$DISABLE_UART" = "true"
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
 fastboot oem uart disable
 EOF
 fi
+if test "$ERASE_APDP" = "true"
+then
+cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
+fastboot erase apdp_a
+fastboot erase apdp_b
+EOF
+fi
 cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
 fastboot -w --skip-reboot update image-$PRODUCT-$VERSION.zip
 fastboot reboot-bootloader
 sleep $SLEEPDURATION
 EOF
 chmod a+x tmp/$PRODUCT-$VERSION/flash-all.sh
 
 # Write flash-all.bat
 cat > tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 @ECHO OFF
@@ -289,20 +296,27 @@ fastboot flash avb_custom_key avb_pkmd.bin
 fastboot reboot-bootloader
 ping -n $SLEEPDURATION 127.0.0.1 >nul
 EOF
 fi
 if test "$DISABLE_UART" = "true"
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 fastboot oem uart disable
 EOF
 fi
+if test "$ERASE_APDP" = "true"
+then
+cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
+fastboot erase apdp_a
+fastboot erase apdp_b
+EOF
+fi
 cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 fastboot -w --skip-reboot update image-$PRODUCT-$VERSION.zip
 fastboot reboot-bootloader
 ping -n $SLEEPDURATION 127.0.0.1 >nul
 
 echo Press any key to exit...
 pause >nul
 exit
 EOF
 

commit acceeca3ae77383cbfa6831b355dc9d5bcd0fa95
Author: flawedworld <flawedworld@flawed.world>
Date:   Fri 2021-12-17 22:10:43+0000

    Add support for erasing msadp
---
 clear-factory-images-variables.sh |  1 +
 generate-factory-images-common.sh | 14 ++++++++++++++
 2 files changed, 15 insertions(+)

diff --git a/clear-factory-images-variables.sh b/clear-factory-images-variables.sh
index c7be106128f5041ca4a053142734eb1b3d259e85..71f4c5dbf1834f78ba0b049f60cc01aa7129062e 100644
--- a/clear-factory-images-variables.sh
+++ b/clear-factory-images-variables.sh
@@ -16,20 +16,21 @@ unset AVB_PKMD
 unset BOOTLOADER
 unset BOOTLOADERFILE
 unset BOOTLOADERSRC
 unset BUILD
 unset CDMARADIO
 unset CDMARADIOFILE
 unset DEVICE
 unset DISABLE_UART
 unset ERASE
 unset ERASE_APDP
+unset ERASE_MSADP
 unset PRODUCT
 unset RADIO
 unset RADIOFILE
 unset RADIOSRC
 unset RADIOFILE
 unset SLEEPDURATION
 unset SRCPREFIX
 unset UNLOCKBOOTLOADER
 unset VERSION
 unset TWINBOOTLOADERS
diff --git a/generate-factory-images-common.sh b/generate-factory-images-common.sh
index 8bfe8a97c7564da31b0d92734d573c55620b8df9..72cf063212c72a1792a4710f6030384990f68529 100644
--- a/generate-factory-images-common.sh
+++ b/generate-factory-images-common.sh
@@ -181,20 +181,27 @@ cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
 fastboot oem uart disable
 EOF
 fi
 if test "$ERASE_APDP" = "true"
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
 fastboot erase apdp_a
 fastboot erase apdp_b
 EOF
 fi
+if test "$ERASE_MSADP" = "true"
+then
+cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
+fastboot erase msadp_a
+fastboot erase msadp_b
+EOF
+fi
 cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
 fastboot -w --skip-reboot update image-$PRODUCT-$VERSION.zip
 fastboot reboot-bootloader
 sleep $SLEEPDURATION
 EOF
 chmod a+x tmp/$PRODUCT-$VERSION/flash-all.sh
 
 # Write flash-all.bat
 cat > tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 @ECHO OFF
@@ -303,20 +310,27 @@ cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 fastboot oem uart disable
 EOF
 fi
 if test "$ERASE_APDP" = "true"
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 fastboot erase apdp_a
 fastboot erase apdp_b
 EOF
 fi
+if test "$ERASE_MSADP" = "true"
+then
+cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
+fastboot erase msadp_a
+fastboot erase msadp_b
+EOF
+fi
 cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 fastboot -w --skip-reboot update image-$PRODUCT-$VERSION.zip
 fastboot reboot-bootloader
 ping -n $SLEEPDURATION 127.0.0.1 >nul
 
 echo Press any key to exit...
 pause >nul
 exit
 EOF
 

commit e7bb9608c2687da1032667cc8c93b0ab50138156
Author: flawedworld <flawedworld@flawed.world>
Date:   Fri 2021-12-17 22:35:42+0000

    Add support for disabling FIPS
---
 clear-factory-images-variables.sh |  1 +
 generate-factory-images-common.sh | 12 ++++++++++++
 2 files changed, 13 insertions(+)

diff --git a/clear-factory-images-variables.sh b/clear-factory-images-variables.sh
index 71f4c5dbf1834f78ba0b049f60cc01aa7129062e..38b6a596546aab8e954ece7afebfacb89de88238 100644
--- a/clear-factory-images-variables.sh
+++ b/clear-factory-images-variables.sh
@@ -13,20 +13,21 @@
 # limitations under the License.
 
 unset AVB_PKMD
 unset BOOTLOADER
 unset BOOTLOADERFILE
 unset BOOTLOADERSRC
 unset BUILD
 unset CDMARADIO
 unset CDMARADIOFILE
 unset DEVICE
+unset DISABLE_FIPS
 unset DISABLE_UART
 unset ERASE
 unset ERASE_APDP
 unset ERASE_MSADP
 unset PRODUCT
 unset RADIO
 unset RADIOFILE
 unset RADIOSRC
 unset RADIOFILE
 unset SLEEPDURATION
diff --git a/generate-factory-images-common.sh b/generate-factory-images-common.sh
index 72cf063212c72a1792a4710f6030384990f68529..2278effab2898bae0d7fe9de782b31916ae07e54 100644
--- a/generate-factory-images-common.sh
+++ b/generate-factory-images-common.sh
@@ -188,20 +188,26 @@ fastboot erase apdp_a
 fastboot erase apdp_b
 EOF
 fi
 if test "$ERASE_MSADP" = "true"
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
 fastboot erase msadp_a
 fastboot erase msadp_b
 EOF
 fi
+if test "$DISABLE_FIPS" = "true"
+then
+cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
+fastboot erase fips
+EOF
+fi
 cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
 fastboot -w --skip-reboot update image-$PRODUCT-$VERSION.zip
 fastboot reboot-bootloader
 sleep $SLEEPDURATION
 EOF
 chmod a+x tmp/$PRODUCT-$VERSION/flash-all.sh
 
 # Write flash-all.bat
 cat > tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 @ECHO OFF
@@ -317,20 +323,26 @@ fastboot erase apdp_a
 fastboot erase apdp_b
 EOF
 fi
 if test "$ERASE_MSADP" = "true"
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 fastboot erase msadp_a
 fastboot erase msadp_b
 EOF
 fi
+if test "$DISABLE_FIPS" = "true"
+then
+cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
+fastboot erase fips
+EOF
+fi
 cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 fastboot -w --skip-reboot update image-$PRODUCT-$VERSION.zip
 fastboot reboot-bootloader
 ping -n $SLEEPDURATION 127.0.0.1 >nul
 
 echo Press any key to exit...
 pause >nul
 exit
 EOF
 

commit 14af7e540a5907480c221db5d3effa5ecbe00969 (HEAD, tag: SP2A.220305.012.2022030801, m/master, grapheneos/12.1)
Author: flawedworld <flawedworld@flawed.world>
Date:   Tue 2022-02-15 23:35:56+0000

    Erase OTA state
---
 generate-factory-images-common.sh | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/generate-factory-images-common.sh b/generate-factory-images-common.sh
index 2278effab2898bae0d7fe9de782b31916ae07e54..e2637147bee46cd4d523d486b9eb804fc953e2c4 100644
--- a/generate-factory-images-common.sh
+++ b/generate-factory-images-common.sh
@@ -195,20 +195,21 @@ fastboot erase msadp_a
 fastboot erase msadp_b
 EOF
 fi
 if test "$DISABLE_FIPS" = "true"
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
 fastboot erase fips
 EOF
 fi
 cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
+fastboot snapshot-update cancel
 fastboot -w --skip-reboot update image-$PRODUCT-$VERSION.zip
 fastboot reboot-bootloader
 sleep $SLEEPDURATION
 EOF
 chmod a+x tmp/$PRODUCT-$VERSION/flash-all.sh
 
 # Write flash-all.bat
 cat > tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 @ECHO OFF
 :: Copyright 2012 The Android Open Source Project
@@ -330,20 +331,21 @@ fastboot erase msadp_a
 fastboot erase msadp_b
 EOF
 fi
 if test "$DISABLE_FIPS" = "true"
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 fastboot erase fips
 EOF
 fi
 cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
+fastboot snapshot-update cancel
 fastboot -w --skip-reboot update image-$PRODUCT-$VERSION.zip
 fastboot reboot-bootloader
 ping -n $SLEEPDURATION 127.0.0.1 >nul
 
 echo Press any key to exit...
 pause >nul
 exit
 EOF
 
 # Write flash-base.sh
