commit 2548f1c385b4afd22f6cb2e760645efadfa6f616
Author: Daniel Micay <danielmicay@gmail.com>
Date:   Wed 2018-12-12 01:10:55-0500

    include AVB custom key with factory images [1/2]
---
 clear-factory-images-variables.sh |  1 +
 generate-factory-images-common.sh | 22 ++++++++++++++++++++++
 2 files changed, 23 insertions(+)

diff --git a/clear-factory-images-variables.sh b/clear-factory-images-variables.sh
index dc508e120fbe4df2c58985dd318f7a5123831916..799f6c4cca21821925bd09a088422b8eb771d0ce 100644
--- a/clear-factory-images-variables.sh
+++ b/clear-factory-images-variables.sh
@@ -5,20 +5,21 @@
 # You may obtain a copy of the License at
 #
 #      http://www.apache.org/licenses/LICENSE-2.0
 #
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
+unset AVB_PKMD
 unset BOOTLOADER
 unset BOOTLOADERFILE
 unset BOOTLOADERSRC
 unset BUILD
 unset CDMARADIO
 unset CDMARADIOFILE
 unset DEVICE
 unset ERASE
 unset PRODUCT
 unset RADIO
diff --git a/generate-factory-images-common.sh b/generate-factory-images-common.sh
index 95f4e35c846810c99d6d46388061d6ef94618116..5628a25578fcbdff23542f68979de40043e87feb 100644
--- a/generate-factory-images-common.sh
+++ b/generate-factory-images-common.sh
@@ -75,20 +75,24 @@ then
 fi
 if test "$CDMARADIO" != ""
 then
   if test "$CDMARADIOFILE" = ""
   then
     cp tmp/RADIO/radio-cdma.img tmp/$PRODUCT-$VERSION/radio-cdma-$DEVICE-$CDMARADIO.img
   else
     cp $CDMARADIOFILE tmp/$PRODUCT-$VERSION/radio-cdma-$DEVICE-$CDMARADIO.img
   fi
 fi
+if test "$AVB_PKMD" != ""
+then
+  cp "$AVB_PKMD" tmp/$PRODUCT-$VERSION/avb_pkmd.bin
+fi
 
 # Write flash-all.sh
 cat > tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
 #!/bin/sh
 
 # Copyright 2012 The Android Open Source Project
 #
 # Licensed under the Apache License, Version 2.0 (the "License");
 # you may not use this file except in compliance with the License.
 # You may obtain a copy of the License at
@@ -150,20 +154,29 @@ sleep $SLEEPDURATION
 EOF
 fi
 if test "$CDMARADIO" != ""
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
 fastboot flash radio-cdma radio-cdma-$DEVICE-$CDMARADIO.img
 fastboot reboot-bootloader
 sleep $SLEEPDURATION
 EOF
 fi
+if test "$AVB_PKMD" != ""
+then
+cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
+fastboot erase avb_custom_key
+fastboot flash avb_custom_key avb_pkmd.bin
+fastboot reboot-bootloader
+sleep $SLEEPDURATION
+EOF
+fi
 cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
 fastboot -w update image-$PRODUCT-$VERSION.zip
 EOF
 chmod a+x tmp/$PRODUCT-$VERSION/flash-all.sh
 
 # Write flash-all.bat
 cat > tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 @ECHO OFF
 :: Copyright 2012 The Android Open Source Project
 ::
@@ -225,20 +238,29 @@ ping -n $SLEEPDURATION 127.0.0.1 >nul
 EOF
 fi
 if test "$CDMARADIO" != ""
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 fastboot flash radio-cdma radio-cdma-$DEVICE-$CDMARADIO.img
 fastboot reboot-bootloader
 ping -n $SLEEPDURATION 127.0.0.1 >nul
 EOF
 fi
+if test "$AVB_PKMD" != ""
+then
+cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
+fastboot erase avb_custom_key
+fastboot flash avb_custom_key avb_pkmd.bin
+fastboot reboot-bootloader
+ping -n $SLEEPDURATION 127.0.0.1 >nul
+EOF
+fi
 cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 fastboot -w update image-$PRODUCT-$VERSION.zip
 
 echo Press any key to exit...
 pause >nul
 exit
 EOF
 
 # Write flash-base.sh
 cat > tmp/$PRODUCT-$VERSION/flash-base.sh << EOF

commit 73db6ef243d1f41d42295fbd3bfb5cc1ac31f480
Author: Daniel Micay <danielmicay@gmail.com>
Date:   Sat 2019-03-16 12:54:05-0400

    use https for common gps configuration
---
 gps/gps.conf_AS      | 6 +++---
 gps/gps.conf_AS_SUPL | 6 +++---
 gps/gps.conf_EU      | 6 +++---
 gps/gps.conf_EU_SUPL | 6 +++---
 gps/gps.conf_US      | 6 +++---
 gps/gps.conf_US_SUPL | 6 +++---
 6 files changed, 18 insertions(+), 18 deletions(-)

diff --git a/gps/gps.conf_AS b/gps/gps.conf_AS
index ce3a4e2cb8c4d8ec3cbc0f2f72e079e64d12a345..4a788f98c2b2f212e62367edc73825edde966770 100644
--- a/gps/gps.conf_AS
+++ b/gps/gps.conf_AS
@@ -1,3 +1,3 @@
-XTRA_SERVER_1=http://xtra1.gpsonextra.net/xtra.bin
-XTRA_SERVER_2=http://xtra2.gpsonextra.net/xtra.bin
-XTRA_SERVER_3=http://xtra3.gpsonextra.net/xtra.bin
+XTRA_SERVER_1=https://xtra1.gpsonextra.net/xtra.bin
+XTRA_SERVER_2=https://xtra2.gpsonextra.net/xtra.bin
+XTRA_SERVER_3=https://xtra3.gpsonextra.net/xtra.bin
diff --git a/gps/gps.conf_AS_SUPL b/gps/gps.conf_AS_SUPL
index a0e2a7d14896c21c63b182900a83b2949ab5b44b..27c95e74132b42ba633f0e420db38c185ab9eea2 100644
--- a/gps/gps.conf_AS_SUPL
+++ b/gps/gps.conf_AS_SUPL
@@ -1,5 +1,5 @@
-XTRA_SERVER_1=http://xtra1.gpsonextra.net/xtra.bin
-XTRA_SERVER_2=http://xtra2.gpsonextra.net/xtra.bin
-XTRA_SERVER_3=http://xtra3.gpsonextra.net/xtra.bin
+XTRA_SERVER_1=https://xtra1.gpsonextra.net/xtra.bin
+XTRA_SERVER_2=https://xtra2.gpsonextra.net/xtra.bin
+XTRA_SERVER_3=https://xtra3.gpsonextra.net/xtra.bin
 SUPL_HOST=supl.google.com
 SUPL_PORT=7276
diff --git a/gps/gps.conf_EU b/gps/gps.conf_EU
index ce3a4e2cb8c4d8ec3cbc0f2f72e079e64d12a345..4a788f98c2b2f212e62367edc73825edde966770 100644
--- a/gps/gps.conf_EU
+++ b/gps/gps.conf_EU
@@ -1,3 +1,3 @@
-XTRA_SERVER_1=http://xtra1.gpsonextra.net/xtra.bin
-XTRA_SERVER_2=http://xtra2.gpsonextra.net/xtra.bin
-XTRA_SERVER_3=http://xtra3.gpsonextra.net/xtra.bin
+XTRA_SERVER_1=https://xtra1.gpsonextra.net/xtra.bin
+XTRA_SERVER_2=https://xtra2.gpsonextra.net/xtra.bin
+XTRA_SERVER_3=https://xtra3.gpsonextra.net/xtra.bin
diff --git a/gps/gps.conf_EU_SUPL b/gps/gps.conf_EU_SUPL
index a0e2a7d14896c21c63b182900a83b2949ab5b44b..27c95e74132b42ba633f0e420db38c185ab9eea2 100644
--- a/gps/gps.conf_EU_SUPL
+++ b/gps/gps.conf_EU_SUPL
@@ -1,5 +1,5 @@
-XTRA_SERVER_1=http://xtra1.gpsonextra.net/xtra.bin
-XTRA_SERVER_2=http://xtra2.gpsonextra.net/xtra.bin
-XTRA_SERVER_3=http://xtra3.gpsonextra.net/xtra.bin
+XTRA_SERVER_1=https://xtra1.gpsonextra.net/xtra.bin
+XTRA_SERVER_2=https://xtra2.gpsonextra.net/xtra.bin
+XTRA_SERVER_3=https://xtra3.gpsonextra.net/xtra.bin
 SUPL_HOST=supl.google.com
 SUPL_PORT=7276
diff --git a/gps/gps.conf_US b/gps/gps.conf_US
index ce3a4e2cb8c4d8ec3cbc0f2f72e079e64d12a345..4a788f98c2b2f212e62367edc73825edde966770 100644
--- a/gps/gps.conf_US
+++ b/gps/gps.conf_US
@@ -1,3 +1,3 @@
-XTRA_SERVER_1=http://xtra1.gpsonextra.net/xtra.bin
-XTRA_SERVER_2=http://xtra2.gpsonextra.net/xtra.bin
-XTRA_SERVER_3=http://xtra3.gpsonextra.net/xtra.bin
+XTRA_SERVER_1=https://xtra1.gpsonextra.net/xtra.bin
+XTRA_SERVER_2=https://xtra2.gpsonextra.net/xtra.bin
+XTRA_SERVER_3=https://xtra3.gpsonextra.net/xtra.bin
diff --git a/gps/gps.conf_US_SUPL b/gps/gps.conf_US_SUPL
index a0e2a7d14896c21c63b182900a83b2949ab5b44b..27c95e74132b42ba633f0e420db38c185ab9eea2 100644
--- a/gps/gps.conf_US_SUPL
+++ b/gps/gps.conf_US_SUPL
@@ -1,5 +1,5 @@
-XTRA_SERVER_1=http://xtra1.gpsonextra.net/xtra.bin
-XTRA_SERVER_2=http://xtra2.gpsonextra.net/xtra.bin
-XTRA_SERVER_3=http://xtra3.gpsonextra.net/xtra.bin
+XTRA_SERVER_1=https://xtra1.gpsonextra.net/xtra.bin
+XTRA_SERVER_2=https://xtra2.gpsonextra.net/xtra.bin
+XTRA_SERVER_3=https://xtra3.gpsonextra.net/xtra.bin
 SUPL_HOST=supl.google.com
 SUPL_PORT=7276

commit a2f3ef6352f729cd59c24586dd1b9204f4da2357
Author: SatelliteSnyper <51929686+SatelliteSnyper@users.noreply.github.com>
Date:   Mon 2019-06-17 20:12:05+0000

    use --skip-reboot to stay in fastboot mode
    
    This allows locking the bootloader without needing to reboot back into
    fastboot mode.
---
 generate-factory-images-common.sh | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/generate-factory-images-common.sh b/generate-factory-images-common.sh
index 5628a25578fcbdff23542f68979de40043e87feb..a138551047a88c13807a0a61f48e38c9c8fc3074 100644
--- a/generate-factory-images-common.sh
+++ b/generate-factory-images-common.sh
@@ -164,21 +164,21 @@ fi
 if test "$AVB_PKMD" != ""
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
 fastboot erase avb_custom_key
 fastboot flash avb_custom_key avb_pkmd.bin
 fastboot reboot-bootloader
 sleep $SLEEPDURATION
 EOF
 fi
 cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
-fastboot -w update image-$PRODUCT-$VERSION.zip
+fastboot -w --skip-reboot update image-$PRODUCT-$VERSION.zip
 EOF
 chmod a+x tmp/$PRODUCT-$VERSION/flash-all.sh
 
 # Write flash-all.bat
 cat > tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 @ECHO OFF
 :: Copyright 2012 The Android Open Source Project
 ::
 :: Licensed under the Apache License, Version 2.0 (the "License");
 :: you may not use this file except in compliance with the License.
@@ -248,21 +248,21 @@ fi
 if test "$AVB_PKMD" != ""
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 fastboot erase avb_custom_key
 fastboot flash avb_custom_key avb_pkmd.bin
 fastboot reboot-bootloader
 ping -n $SLEEPDURATION 127.0.0.1 >nul
 EOF
 fi
 cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
-fastboot -w update image-$PRODUCT-$VERSION.zip
+fastboot -w --skip-reboot update image-$PRODUCT-$VERSION.zip
 
 echo Press any key to exit...
 pause >nul
 exit
 EOF
 
 # Write flash-base.sh
 cat > tmp/$PRODUCT-$VERSION/flash-base.sh << EOF
 #!/bin/sh
 

commit 77ace111ea900b41c86adcae2c0e77655362055f
Author: Daniel Micay <danielmicay@gmail.com>
Date:   Fri 2020-05-01 15:52:26-0400

    use more sensible factory images zip naming scheme
---
 generate-factory-images-common.sh | 3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

diff --git a/generate-factory-images-common.sh b/generate-factory-images-common.sh
index a138551047a88c13807a0a61f48e38c9c8fc3074..9a318e598fe13c46b6f9ff2ecd01f48563a7b75e 100644
--- a/generate-factory-images-common.sh
+++ b/generate-factory-images-common.sh
@@ -316,15 +316,14 @@ if test "$CDMARADIO" != ""
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-base.sh << EOF
 fastboot flash radio-cdma radio-cdma-$DEVICE-$CDMARADIO.img
 fastboot reboot-bootloader
 sleep $SLEEPDURATION
 EOF
 fi
 chmod a+x tmp/$PRODUCT-$VERSION/flash-base.sh
 
 # Create the distributable package
-(cd tmp ; zip -r ../$PRODUCT-$VERSION-factory.zip $PRODUCT-$VERSION)
-mv $PRODUCT-$VERSION-factory.zip $PRODUCT-$VERSION-factory-$(sha256sum < $PRODUCT-$VERSION-factory.zip | cut -b -8).zip
+(cd tmp; mv $PRODUCT-$VERSION $PRODUCT-factory-$VERSION; zip -r ../$PRODUCT-factory-$VERSION.zip $PRODUCT-factory-$VERSION)
 
 # Clean up
 rm -rf tmp

commit bd535e3ce30d4cdc7d98c9fb6508b615e4e8ab1f
Author: JTL <jtl999@users.noreply.github.com>
Date:   Mon 2020-06-01 10:45:25-0700

    Fastboot version detection on Windows using inline PowerShell
---
 generate-factory-images-common.sh | 21 +++++++++++++++++++++
 1 file changed, 21 insertions(+)

diff --git a/generate-factory-images-common.sh b/generate-factory-images-common.sh
index 9a318e598fe13c46b6f9ff2ecd01f48563a7b75e..197a70dfff797e20dcdb41743d64f55ccf3f3720 100644
--- a/generate-factory-images-common.sh
+++ b/generate-factory-images-common.sh
@@ -186,20 +186,41 @@ cat > tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 ::
 ::      http://www.apache.org/licenses/LICENSE-2.0
 ::
 :: Unless required by applicable law or agreed to in writing, software
 :: distributed under the License is distributed on an "AS IS" BASIS,
 :: WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 :: See the License for the specific language governing permissions and
 :: limitations under the License.
 
 PATH=%PATH%;"%SYSTEMROOT%\System32"
+
+:: Detect Fastboot version with inline PowerShell
+:: Should work with Windows 7 and later
+
+@PowerShell ^
+\$version=fastboot --version; ^
+try { ^
+    \$verNum = \$version[0].substring(17, 6); ^
+    \$verNum = \$verNum.replace('.', ''); ^
+    if ((-Not (\$verNum -gt 3103)) -Or (-Not (\$verNum -match '^[\d.]+$'))) { ^
+        Exit 1 ^
+    } ^
+} catch { ^
+    Exit 1 ^
+}
+
+IF %ERRORLEVEL% NEQ 0 (
+  ECHO fastboot too old; please download the latest version at https://developer.android.com/studio/releases/platform-tools.html
+  EXIT /B
+)
+
 EOF
 if test "$UNLOCKBOOTLOADER" = "true"
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 fastboot oem unlock
 EOF
 fi
 if test "$ERASEALL" = "true"
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF

commit 84f0258f90e5f05d0c45e174b3c571b1c468c6fd
Author: Chirayu Desai <chirayudesai1@gmail.com>
Date:   Wed 2020-06-03 03:59:34+0530

    Reboot to bootloader after installing update
    
    * Can't lock bootloader from fastbootd,
      reboot to bootloader to allow that.
    * Doesn't hurt on other devices, keeps the script simple.
---
 generate-factory-images-common.sh | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/generate-factory-images-common.sh b/generate-factory-images-common.sh
index 197a70dfff797e20dcdb41743d64f55ccf3f3720..3083f747c4ce6f54c891e53a96c0c03133973dee 100644
--- a/generate-factory-images-common.sh
+++ b/generate-factory-images-common.sh
@@ -165,20 +165,22 @@ if test "$AVB_PKMD" != ""
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
 fastboot erase avb_custom_key
 fastboot flash avb_custom_key avb_pkmd.bin
 fastboot reboot-bootloader
 sleep $SLEEPDURATION
 EOF
 fi
 cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
 fastboot -w --skip-reboot update image-$PRODUCT-$VERSION.zip
+fastboot reboot-bootloader
+sleep $SLEEPDURATION
 EOF
 chmod a+x tmp/$PRODUCT-$VERSION/flash-all.sh
 
 # Write flash-all.bat
 cat > tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 @ECHO OFF
 :: Copyright 2012 The Android Open Source Project
 ::
 :: Licensed under the Apache License, Version 2.0 (the "License");
 :: you may not use this file except in compliance with the License.
@@ -270,20 +272,22 @@ if test "$AVB_PKMD" != ""
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 fastboot erase avb_custom_key
 fastboot flash avb_custom_key avb_pkmd.bin
 fastboot reboot-bootloader
 ping -n $SLEEPDURATION 127.0.0.1 >nul
 EOF
 fi
 cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 fastboot -w --skip-reboot update image-$PRODUCT-$VERSION.zip
+fastboot reboot-bootloader
+ping -n $SLEEPDURATION 127.0.0.1 >nul
 
 echo Press any key to exit...
 pause >nul
 exit
 EOF
 
 # Write flash-base.sh
 cat > tmp/$PRODUCT-$VERSION/flash-base.sh << EOF
 #!/bin/sh
 

commit e1fde05707766cd0baaaf1becb3465c5ebdb9762
Author: Maxim Baz <git@maximbaz.com>
Date:   Tue 2020-10-27 16:25:20+0100

    gracefully handle absence of fastboot
---
 generate-factory-images-common.sh | 12 ++++++++++++
 1 file changed, 12 insertions(+)

diff --git a/generate-factory-images-common.sh b/generate-factory-images-common.sh
index 3083f747c4ce6f54c891e53a96c0c03133973dee..1c13bc9d109ea3c6979083779878ce2190b02b49 100644
--- a/generate-factory-images-common.sh
+++ b/generate-factory-images-common.sh
@@ -98,20 +98,25 @@ cat > tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
 # You may obtain a copy of the License at
 #
 #      http://www.apache.org/licenses/LICENSE-2.0
 #
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
+if ! command -v fastboot > /dev/null; then
+  echo "fastboot not found; please download the latest version at https://developer.android.com/studio/releases/platform-tools.html and add it to the shell PATH"
+  exit 1
+fi
+
 if ! [ \$(\$(which fastboot) --version | grep "version" | cut -c18-23 | sed 's/\.//g' ) -ge 3103 ]; then
   echo "fastboot too old; please download the latest version at https://developer.android.com/studio/releases/platform-tools.html"
   exit 1
 fi
 EOF
 if test "$UNLOCKBOOTLOADER" = "true"
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
 fastboot oem unlock
 EOF
@@ -192,20 +197,22 @@ cat > tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 :: distributed under the License is distributed on an "AS IS" BASIS,
 :: WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 :: See the License for the specific language governing permissions and
 :: limitations under the License.
 
 PATH=%PATH%;"%SYSTEMROOT%\System32"
 
 :: Detect Fastboot version with inline PowerShell
 :: Should work with Windows 7 and later
 
+where /q fastboot || ECHO fastboot not found; please download the latest version at https://developer.android.com/studio/releases/platform-tools.html and add it to the shell PATH && EXIT /B
+
 @PowerShell ^
 \$version=fastboot --version; ^
 try { ^
     \$verNum = \$version[0].substring(17, 6); ^
     \$verNum = \$verNum.replace('.', ''); ^
     if ((-Not (\$verNum -gt 3103)) -Or (-Not (\$verNum -match '^[\d.]+$'))) { ^
         Exit 1 ^
     } ^
 } catch { ^
     Exit 1 ^
@@ -298,20 +305,25 @@ cat > tmp/$PRODUCT-$VERSION/flash-base.sh << EOF
 # You may obtain a copy of the License at
 #
 #      http://www.apache.org/licenses/LICENSE-2.0
 #
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
+if ! command -v fastboot > /dev/null; then
+  echo "fastboot not found; please download the latest version at https://developer.android.com/studio/releases/platform-tools.html and add it to the shell PATH"
+  exit 1
+fi
+
 if ! [ \$(\$(which fastboot) --version | grep "version" | cut -c18-23 | sed 's/\.//g' ) -ge 3103 ]; then
   echo "fastboot too old; please download the latest version at https://developer.android.com/studio/releases/platform-tools.html"
   exit 1
 fi
 EOF
 if test "$XLOADER" != ""
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-base.sh << EOF
 fastboot flash xloader xloader-$DEVICE-$XLOADER.img
 EOF

commit dbf9de67ae0fd8600536e63664cb13418b28c8f0 (HEAD, m/master, grapheneos/12)
Author: flawedworld <38294951+flawedworld@users.noreply.github.com>
Date:   Tue 2021-07-13 18:24:44+0000

    Add support for disabling UART
---
 clear-factory-images-variables.sh |  1 +
 generate-factory-images-common.sh | 12 ++++++++++++
 2 files changed, 13 insertions(+)

diff --git a/clear-factory-images-variables.sh b/clear-factory-images-variables.sh
index 799f6c4cca21821925bd09a088422b8eb771d0ce..cb5895c930041e70f236933826df59c63993b056 100644
--- a/clear-factory-images-variables.sh
+++ b/clear-factory-images-variables.sh
@@ -13,20 +13,21 @@
 # limitations under the License.
 
 unset AVB_PKMD
 unset BOOTLOADER
 unset BOOTLOADERFILE
 unset BOOTLOADERSRC
 unset BUILD
 unset CDMARADIO
 unset CDMARADIOFILE
 unset DEVICE
+unset DISABLE_UART
 unset ERASE
 unset PRODUCT
 unset RADIO
 unset RADIOFILE
 unset RADIOSRC
 unset RADIOFILE
 unset SLEEPDURATION
 unset SRCPREFIX
 unset UNLOCKBOOTLOADER
 unset VERSION
diff --git a/generate-factory-images-common.sh b/generate-factory-images-common.sh
index 1c13bc9d109ea3c6979083779878ce2190b02b49..e18661ccab767d6eeab3672af108dfcbb76180ee 100644
--- a/generate-factory-images-common.sh
+++ b/generate-factory-images-common.sh
@@ -168,20 +168,26 @@ EOF
 fi
 if test "$AVB_PKMD" != ""
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
 fastboot erase avb_custom_key
 fastboot flash avb_custom_key avb_pkmd.bin
 fastboot reboot-bootloader
 sleep $SLEEPDURATION
 EOF
 fi
+if test "$DISABLE_UART" = "true"
+then
+cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
+fastboot oem uart disable
+EOF
+fi
 cat >> tmp/$PRODUCT-$VERSION/flash-all.sh << EOF
 fastboot -w --skip-reboot update image-$PRODUCT-$VERSION.zip
 fastboot reboot-bootloader
 sleep $SLEEPDURATION
 EOF
 chmod a+x tmp/$PRODUCT-$VERSION/flash-all.sh
 
 # Write flash-all.bat
 cat > tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 @ECHO OFF
@@ -277,20 +283,26 @@ EOF
 fi
 if test "$AVB_PKMD" != ""
 then
 cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 fastboot erase avb_custom_key
 fastboot flash avb_custom_key avb_pkmd.bin
 fastboot reboot-bootloader
 ping -n $SLEEPDURATION 127.0.0.1 >nul
 EOF
 fi
+if test "$DISABLE_UART" = "true"
+then
+cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
+fastboot oem uart disable
+EOF
+fi
 cat >> tmp/$PRODUCT-$VERSION/flash-all.bat << EOF
 fastboot -w --skip-reboot update image-$PRODUCT-$VERSION.zip
 fastboot reboot-bootloader
 ping -n $SLEEPDURATION 127.0.0.1 >nul
 
 echo Press any key to exit...
 pause >nul
 exit
 EOF
 
