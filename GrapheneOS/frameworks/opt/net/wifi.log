commit 776beebd3d221740ac1b77d8535f745415d171a0 (HEAD, tag: SP2A.220305.012.2022030801, m/master, grapheneos/12.1)
Author: renlord <me@renlord.com>
Date:   Fri 2021-10-15 19:11:18+0530

    add support for always generating new random MAC
    
    To trigger re-generation of randomized MAC addressed for an already
    connected AP. User simply has to toggle on/off wifi. Otherwise, on
    re-connection, a new randomized MAC address also gets generated.
    
    based on https://github.com/GrapheneOS/platform_frameworks_opt_net_wifi/commit/a0d9bda06b71694f38fe02bbe24628ee21a7d270
---
 .../android/wifitrackerlib/StandardWifiEntry.java  | 32 ++++++++++++++++------
 .../src/com/android/wifitrackerlib/WifiEntry.java  |  1 +
 2 files changed, 25 insertions(+), 8 deletions(-)

diff --git a/libs/WifiTrackerLib/src/com/android/wifitrackerlib/StandardWifiEntry.java b/libs/WifiTrackerLib/src/com/android/wifitrackerlib/StandardWifiEntry.java
index 4f63ced830f13ba8414e1a4a74e2dfba32ae5e5b..3d3000d335625a16685a12b6b2a964e125fa937f 100644
--- a/libs/WifiTrackerLib/src/com/android/wifitrackerlib/StandardWifiEntry.java
+++ b/libs/WifiTrackerLib/src/com/android/wifitrackerlib/StandardWifiEntry.java
@@ -253,21 +253,21 @@ public class StandardWifiEntry extends WifiEntry {
 
     @Override
     public synchronized String getMacAddress() {
         if (mWifiInfo != null) {
             final String wifiInfoMac = mWifiInfo.getMacAddress();
             if (!TextUtils.isEmpty(wifiInfoMac)
                     && !TextUtils.equals(wifiInfoMac, DEFAULT_MAC_ADDRESS)) {
                 return wifiInfoMac;
             }
         }
-        if (mTargetWifiConfig == null || getPrivacy() != PRIVACY_RANDOMIZED_MAC) {
+        if (mTargetWifiConfig == null || getPrivacy() == PRIVACY_DEVICE_MAC) {
             final String[] factoryMacs = mWifiManager.getFactoryMacAddresses();
             if (factoryMacs.length > 0) {
                 return factoryMacs[0];
             }
             return null;
         }
         return mTargetWifiConfig.getRandomizedMacAddress().toString();
     }
 
     @Override
@@ -515,40 +515,56 @@ public class StandardWifiEntry extends WifiEntry {
     }
 
     @Override
     public boolean canSetPrivacy() {
         return isSaved();
     }
 
     @Override
     @Privacy
     public synchronized int getPrivacy() {
-        if (mTargetWifiConfig != null
-                && mTargetWifiConfig.macRandomizationSetting
-                == WifiConfiguration.RANDOMIZATION_NONE) {
-            return PRIVACY_DEVICE_MAC;
+        if (mTargetWifiConfig != null) {
+            switch (mTargetWifiConfig.macRandomizationSetting) {
+                case WifiConfiguration.RANDOMIZATION_NONE:
+                    return PRIVACY_DEVICE_MAC;
+                case WifiConfiguration.RANDOMIZATION_ALWAYS:
+                    return PRIVACY_RANDOMIZATION_ALWAYS;
+                default:
+                    // WifiConfiguration.RANDOMIZATION_AUTO and WifiConfiguration.RANDOMIZATION_PERSISTENT
+                    return PRIVACY_RANDOMIZED_MAC;
+            }
         } else {
-            return PRIVACY_RANDOMIZED_MAC;
+            return PRIVACY_RANDOMIZATION_ALWAYS;
         }
     }
 
     @Override
     public synchronized void setPrivacy(int privacy) {
         if (!canSetPrivacy()) {
             return;
         }
 
-        mTargetWifiConfig.macRandomizationSetting = privacy == PRIVACY_RANDOMIZED_MAC
-                ? WifiConfiguration.RANDOMIZATION_AUTO : WifiConfiguration.RANDOMIZATION_NONE;
+        mTargetWifiConfig.macRandomizationSetting = translatePrivacyToWifiConfigurationValues(privacy);
         mWifiManager.save(mTargetWifiConfig, null /* listener */);
     }
 
+    private static int translatePrivacyToWifiConfigurationValues(int privacyValue) {
+        switch (privacyValue) {
+            case PRIVACY_RANDOMIZED_MAC:
+                return WifiConfiguration.RANDOMIZATION_PERSISTENT;
+            case PRIVACY_DEVICE_MAC:
+                return WifiConfiguration.RANDOMIZATION_NONE;
+            default:
+                return WifiConfiguration.RANDOMIZATION_ALWAYS;
+        }
+    }
+
     @Override
     public synchronized boolean isAutoJoinEnabled() {
         if (mTargetWifiConfig == null) {
             return false;
         }
 
         return mTargetWifiConfig.allowAutojoin;
     }
 
     @Override
diff --git a/libs/WifiTrackerLib/src/com/android/wifitrackerlib/WifiEntry.java b/libs/WifiTrackerLib/src/com/android/wifitrackerlib/WifiEntry.java
index 15edf8a1888e162014bb7d5ab844698a78302493..e3bc3a45ba63bc8188ea9e562b776f31fc2ab192 100644
--- a/libs/WifiTrackerLib/src/com/android/wifitrackerlib/WifiEntry.java
+++ b/libs/WifiTrackerLib/src/com/android/wifitrackerlib/WifiEntry.java
@@ -149,20 +149,21 @@ public class WifiEntry implements Comparable<WifiEntry> {
             PRIVACY_DEVICE_MAC,
             PRIVACY_RANDOMIZED_MAC,
             PRIVACY_UNKNOWN
     })
 
     public @interface Privacy {}
 
     public static final int PRIVACY_DEVICE_MAC = 0;
     public static final int PRIVACY_RANDOMIZED_MAC = 1;
     public static final int PRIVACY_UNKNOWN = 2;
+    public static final int PRIVACY_RANDOMIZATION_ALWAYS = 100;
 
     @Retention(RetentionPolicy.SOURCE)
     @IntDef(value = {
             FREQUENCY_2_4_GHZ,
             FREQUENCY_5_GHZ,
             FREQUENCY_6_GHZ,
             FREQUENCY_60_GHZ,
             FREQUENCY_UNKNOWN
     })
 
